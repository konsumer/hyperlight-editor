<html>
    <head>
        <title>Hyperlight editor</title>
        <style>
            body {
                font-family: sans-serif;
                padding: 20px;
            }
            dl {
                margin-bottom: 40px;
            }
            div {
                margin-bottom: 20px;
            }
        </style>
    </head>
    <body>
        <h1>Hyperlight editor</h1>
        <p>This will allow you to edit the values in a save file.</p>
        <p>If you are copying a file from another computer, first load it and record the ID, then load your file, and set the ID.</p>
        <p>Here are some ideas of where to find it:</p>
        <dl class="dl-horizontal well">
            <dt>OSX</dt>
            <dd><code>~/Library/Application Support/com.HeartMachine.HyperLightDrifter</code></dd>
            <dt>Windows</dt>
            <dd><code>%LOCALAPPDATA%\HyperLightDrifter</code></dd>
            <dt>Linux</dt>
            <dd><code>~/.config/HyperLightDrifter</code></dd>
        </dl>

        <div>
            <label>Save File: <input type="file" /></label>
        </div>

        <form id="value">

        <div>
            <label>Name: <input type="text" name="name" /></label><br />
        </div>

        <div>
            <label>ID: <input type="text" name="id" /></label><br />
            <small>Use this to copy a file from different computers.</small>
        </div>

        <div><button>Save</button></div>

        <h2>Stats</h2>

        <div>
        <label>
            Deaths:
            <input type="number" name="deaths" value="0" step="1" min="0" max="16" />
        </label>
        </div>

        <div>
        <label>
            Health:
            <input type="number" name="hp" value="0" step="1" min="0" max="2"/>
        </label>
        </div>

        <h2>Items</h2>

        <div>
            <label>
                Keys:
                <input type="number" name="keys" value="0" step="1" min="0" max="16" />
            </label>
        </div>
        <div>
            <label>
                Gears:
                <input type="number" name="gear" value="0" step="1" min="0" />
            </label>
        </div>

        <h3>Shards</h3>
        <ul>
            <li>
                <input type="checkbox" name="shard_north_0" />
                <input type="checkbox" name="shard_north_1" />
                <input type="checkbox" name="shard_north_2" />
                <input type="checkbox" name="shard_north_3" />
                North
            </li>
            <li>
                <input type="checkbox" name="shard_west_0" />
                <input type="checkbox" name="shard_west_1" />
                <input type="checkbox" name="shard_west_2" />
                <input type="checkbox" name="shard_west_3" />
                West
            </li>
            <li>
                <input type="checkbox" name="shard_south_0" />
                <input type="checkbox" name="shard_south_1" />
                <input type="checkbox" name="shard_south_2" />
                <input type="checkbox" name="shard_south_3" />
                South
            </li>
            <li>
                <input type="checkbox" name="shard_east_0" />
                <input type="checkbox" name="shard_east_1" />
                <input type="checkbox" name="shard_east_2" />
                <input type="checkbox" name="shard_east_3" />
                East
            </li>
        </ul>
        <h3>Outfit</h3>
        <ul id="outfits">
            <li>
                <label>
                    <input type="checkbox" name="outfit_red" checked disabled value="0" />
                    Red
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_blue" value="1" />
                    Blue
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_fuscia" value="2" />
                    Fuscia
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_white" value="3" />
                    White
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_yellow" value="4" />
                    Yellow
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_orange" value="5" />
                    Orange
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_greenblue" value="6" />
                    Green/Blue
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_pink" value="7" />
                    Pink
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_black" value="8" />
                    Black
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_ochre" value="9" />
                    Ochre
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_purple" value="10" />
                    Purple
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="outfit_ngplus" value="11" />
                    NG+ (has side-effects)
                </label>
            </li>
        </ul>
        <h3>Sword</h3>
        <ul id="swords">
            <li>
                <label>
                    <input type="checkbox" name="sword_red" checked disabled value="0" />
                    Red
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_blue" value="1" />
                    Blue
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_fuscia" value="2" />
                    Fuscia
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_white" value="3" />
                    White
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_yellow" value="4" />
                    Yellow
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_orange" value="5" />
                    Orange
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_greenblue" value="6" />
                    Green/Blue
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_pink" value="7" />
                    Pink
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_black" value="8" />
                    Black
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_ochre" value="9" />
                    Ochre
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_purple" value="10" />
                    Purple
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="sword_ngplus" value="11" />
                    NG+ (has side-effects)
                </label>
            </li>
        </ul>
        <h3>Companion</h3>
        <ul id="companions">
            <li>
                <label>
                    <input type="checkbox" name="companion_red" checked disabled value="0" />
                    Red
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_blue" value="1" />
                    Blue
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_fuscia" value="2" />
                    Fuscia
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_white" value="3" />
                    White
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_yellow" value="4" />
                    Yellow
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_orange" value="5" />
                    Orange
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_greenblue" value="6" />
                    Green/Blue
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_pink" value="7" />
                    Pink
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_black" value="8" />
                    Black
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_ochre" value="9" />
                    Ochre
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_purple" value="10" />
                    Purple
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_gold" value="12" />
                    Gold (cosmetic only)
                </label>
            </li>
            <li>
                <label>
                    <input type="checkbox" name="companion_ngplus" value="11" />
                    NG+ (HACKED)
                </label>
            </li>
        </ul>
        </form>
        <script>
            // shared data of current file
            let data;

            // download a file
            function download(
                filename,
                contents,
                type = "application/octet-stream",
            ) {
                const blob = new Blob([contents], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            // decode a file buffer (base64 text)
            function decode(text) {
                const buffer = atob(text);
                const header = buffer.slice(0, 60);
                const settings = JSON.parse(buffer.slice(60, -1));
                return { header, settings };
            }

            // encode a file buffer (base64 text)
            function encode({ settings }) {
                const json = JSON.stringify(settings);
                const header = atob(document.querySelector('input[name="id"]').value)
                return btoa(`${header}${json}\u0000`);
            }

            document
                .querySelector('input[type="file"]')
                .addEventListener("change", async (event) => {
                    data = decode(await event.target.files[0].text());
                    data.name = event.target.files[0].name;
                    document.querySelector('input[name="id"]').value = btoa(data.header);

                    // take all settings and update UI

                    document.querySelector('input[name="name"]').value = data.settings.gameName
                    document.querySelector('input[name="deaths"]').value = data.settings.charDeaths || 0;
                    document.querySelector('input[name="gear"]').value = data.settings.gear || 0;
                    document.querySelector('input[name="hp"]').value = data.settings.healthUP || 0;



                    console.log(data);
                });

            document
                .querySelector("button")
                .addEventListener("click", (event) => {
                    // TODO: read all UI values into data.settings
                    download(data.name, encode(data));
                });
        </script>
    </body>
</html>
